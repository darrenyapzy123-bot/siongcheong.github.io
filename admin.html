<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
        // 注意：这里补充引入了 serverTimestamp
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

        // 您的真实 Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDacu1ZcdR79rlWJju091GqDHdwbwLM9YE",
            authDomain: "siong-cheong-trading-website.firebaseapp.com",
            projectId: "siong-cheong-trading-website",
            storageBucket: "siong-cheong-trading-website.firebasestorage.app",
            messagingSenderId: "7084102902",
            appId: "1:7084102902:web:5c833ed769d592259848d7",
            measurementId: "G-KTGD0L7DZN"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentImageBase64 = null;

        // 暴露函数给 HTML 按钮使用
        window.login = login;
        window.logout = logout;
        window.submitProduct = submitProduct;
        window.clearForm = clearForm;
        window.handleFileSelect = handleFileSelect;
        window.removeImage = removeImage;
        window.updatePreview = updatePreview;
        window.deleteProduct = deleteProduct;

        // --- Auth Logic: 监听登录状态 ---
        // 这一步非常关键：防止刷新页面后丢失登录状态
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // 已登录
                console.log("User is logged in:", user.email);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadProducts(); 
            } else {
                // 未登录
                console.log("User is logged out");
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        async function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');

            try {
                // 必须使用真实 Firebase 登录，否则无法获得写入权限
                await signInWithEmailAndPassword(auth, email, pass);
                // 登录成功后，onAuthStateChanged 会处理 UI 切换
            } catch (error) {
                console.error("Firebase Login Error:", error);
                errorMsg.textContent = "Login Failed: " + error.message;
                
                // ⚠️ 警告：我删除了之前的假登录代码。
                // 如果你使用那个假登录，你永远拿不到 Firebase 的写入权限 (Permission Denied)。
            }
        }

        async function logout() {
            await signOut(auth);
            // 登出后，onAuthStateChanged 会自动把页面切回登录框
        }

        // --- Image Upload Logic ---
        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentImageBase64 = e.target.result;
                    document.getElementById('drop-zone').style.display = 'none';
                    document.getElementById('preview-container').style.display = 'flex';
                    document.getElementById('uploaded-image').src = currentImageBase64;
                    document.getElementById('prev-img').src = currentImageBase64;
                }
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            currentImageBase64 = null;
            document.getElementById('fileInput').value = "";
            document.getElementById('drop-zone').style.display = 'block';
            document.getElementById('preview-container').style.display = 'none';
            document.getElementById('prev-img').src = "https://placehold.co/300x300/1e293b/FFF?text=Product+Image";
        }

        function updatePreview() {
            const brand = document.getElementById('p-brand').value || "Brand";
            const model = document.getElementById('p-model').value || "Product Model";
            const hp = document.getElementById('p-hp').value || "1.0";
            const type = document.getElementById('p-type').value || "Inverter";
            const desc = document.getElementById('p-desc').value || "Product description will appear here...";

            document.getElementById('prev-brand').textContent = brand;
            document.getElementById('prev-title').textContent = model;
            document.getElementById('prev-hp').textContent = hp + " HP";
            document.getElementById('prev-type').textContent = type;
            document.getElementById('prev-desc').textContent = desc;
        }

        // --- Firestore: Add Product ---
        async function submitProduct() {
            console.log("Attempting to submit product..."); // 调试点 1

            const category = document.getElementById('p-category').value;
            const brand = document.getElementById('p-brand').value.trim(); // 加入 .trim()
            const model = document.getElementById('p-model').value.trim();
            const hp = document.getElementById('p-hp').value;
            const type = document.getElementById('p-type').value;
            const tag = document.getElementById('p-tag').value.trim();
            const desc = document.getElementById('p-desc').value.trim();

            // 严谨验证：确保不是空字符串
            if (!brand || !model || !desc) {
                showToast("Please fill in Brand, Model and Description.", "error");
                return;
            }

            try {
                const productData = {
                    category,
                    brand,
                    model,
                    hp: hp,
                    type: type,
                    tag: tag || (hp + " HP " + type),
                    description: desc,
                    image: currentImageBase64 || "", 
                    // ✅ 核心修正：使用 serverTimestamp
                    createdAt: serverTimestamp() 
                };

                console.log("Data to write:", productData); // 调试点 2

                await addDoc(collection(db, "products"), productData);

                console.log("Write Success!"); // 调试点 3
                showToast("Product Published Successfully!", "success");
                clearForm();
                loadProducts(); 
            } catch (e) {
                console.error("Error adding document: ", e); // 调试点 4
                
                if(e.code === 'permission-denied') {
                    showToast("Permission Denied! You are not logged in properly.", "error");
                } else {
                    showToast("Error: " + e.message, "error");
                }
            }
        }

        function clearForm() {
            document.getElementById('p-brand').value = "";
            document.getElementById('p-model').value = "";
            document.getElementById('p-tag').value = "";
            document.getElementById('p-desc').value = "";
            removeImage();
            updatePreview();
        }

        // --- Firestore: Read & Delete Products ---
        async function loadProducts() {
            const listContainer = document.getElementById('manage-list');
            listContainer.innerHTML = '<p style="color:var(--text-sub);">Loading from Firestore...</p>';

            try {
                // ✅ 核心修正：加入排序逻辑 (OrderBy createdAt desc)
                // 确保你在 Firestore Console 建立了索引（如果控制台报错提示缺索引，点击链接即可）
                const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
                
                const querySnapshot = await getDocs(q);
                
                listContainer.innerHTML = ''; 

                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p style="color:var(--text-sub);">No products found.</p>';
                    return;
                }

                querySnapshot.forEach((docSnap) => {
                    const product = docSnap.data();
                    const pid = docSnap.id;
                    const img = product.image || "https://placehold.co/50x50/333/fff?text=N";

                    const item = document.createElement('div');
                    item.className = 'manage-item';
                    item.innerHTML = `
                        <div class="item-info">
                            <img src="${img}" class="item-thumb" alt="Thumb">
                            <div class="item-details">
                                <h4>${product.brand} - ${product.model}</h4>
                                <span>${product.category} | ${product.hp}HP</span>
                            </div>
                        </div>
                        <button class="btn-delete" onclick="deleteProduct('${pid}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    `;
                    listContainer.appendChild(item);
                });
            } catch (e) {
                console.error("Error loading products: ", e);
                listContainer.innerHTML = `<p style="color:var(--error);">Error: ${e.message}</p>`;
            }
        }

        async function deleteProduct(id) {
            if(confirm("Are you sure you want to delete this product?")) {
                try {
                    await deleteDoc(doc(db, "products", id));
                    showToast("Product deleted successfully!", "success");
                    loadProducts(); 
                } catch (e) {
                    console.error("Error deleting: ", e);
                    showToast("Error deleting product.", "error");
                }
            }
        }

        function showToast(message, type) {
            const toast = document.getElementById("toast");
            toast.className = "show " + type;
            toast.textContent = message;
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }
    </script>
